---
title: "Spatial Relationships"
author: "Gemma Holt"
date: "9/23/2020"
output:
  html_document:
    theme: lumen
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning = FALSE)
```
## Setup
```{r}
library(sf)
library(tidyverse)
library(ggthemes)
library(ggspatial)
library(units)
library(nngeo)
library(dplyr)
```


### Loading the data
```{r}
nhoods <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/3525b0ee6e6b427f9aab5d0a1d0a1a28_0.kml?outSR={%22latestWkid%22:2249,%22wkid%22:102686}", quiet = TRUE)

libraries <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/cb00f9248aa6404ab741071ca3806c0e_6.kml?outSR={%22latestWkid%22:2249,%22wkid%22:102686}", quiet = TRUE)

schools <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/1d9509a8b2fd485d9ad471ba2fdb1f90_0.kml?outSR={%22latestWkid%22:2249,%22wkid%22:102686}", quiet = TRUE)

water <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/2b3c0fa13b1c468eb702a3645fcc6bcb_5.kml",quiet = TRUE)

parks <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/2868d370c55d4d458d4ae2224ef8cddd_7.kml", quiet = TRUE)

```

## Transforming the data

### Transforming to Massachusetts
```{r}
MA_state_plane <- "+proj=lcc +lat_1=41.71666666666667 +lat_2=42.68333333333333 +lat_0=41 +lon_0=-71.5 +x_0=200000 +y_0=750000 +ellps=GRS80 +units=m +no_defs"

nhoods <- nhoods %>%
  st_transform(MA_state_plane)

libraries <- libraries %>%
  st_transform(MA_state_plane)

schools <- schools %>%
  st_transform(MA_state_plane)

water <- water %>%
  st_transform(MA_state_plane)

parks <- parks %>%
  st_transform(MA_state_plane)
```


## Mapping the data
```{r, include=FALSE}
ggplot(nhoods) +
  geom_sf(fill = NA, color = "black") +
  geom_sf(data = schools, color = "orange", size = 1) +
  geom_sf(data = libraries, color = "blue", size = 2) +
  geom_sf(data = parks, fill = "darkgreen", color = NA) +
  theme_map() +
  annotation_scale()
```


###  Creating a buffer
```{r, include=FALSE}
eastboston <- 

schools_buffer <- st_buffer(schools, dist = 250) %>%
  st_union()

ggplot(schools_buffer) +
  geom_sf() +
  theme_map()
```


### Subsetting points in a polygon
Copied this from Carole's tutorial
```{r}
libraries_schools <- libraries[schools_buffer,]
  
ggplot(schools_buffer) +
  geom_sf() +
  geom_sf(data = libraries_schools, 
          color = "blue", 
          size = 1) +
  theme_map()
```


### The number of libraries within 250m of public schools
The number and proportion of A points within a specified distance of B points.
```{r}
libraries <- libraries %>%
  st_join(libraries_schools) %>%
  mutate(by_schools = !is.na(Name.y))

n_schools_libraries <- sum(libraries$by_schools)

n_schools_libraries
```
```{r}
n_libraries <- length(libraries$by_schools)

pct_schools_libraries <- n_schools_libraries / n_libraries

pct_schools_libraries
```
```{r}
left_side  <- st_bbox(libraries)$xmin
top_side <- st_bbox(libraries)$ymax

libraries_by_schools <- ggplot(nhoods) +
  geom_sf(fill = "grey92", color = "grey46") +
  geom_sf(data = libraries, size = 2,
          aes(color = by_schools)) +
  scale_color_manual(values = c("lightgreen", "darkgreen"),
  name = "Libraries\nby distance to a public school", 
  labels = c("No school within 250 m",
                     "School within 250 m")) +
  annotation_scale(location = "br") +
  annotate(geom = "text", x = left_side, 
           y = top_side, 
           label = paste("Of the ",
                   prettyNum(n_libraries, big.mark = ","),
                   " libraries in Boston\n",
                   prettyNum(n_schools_libraries, big.mark = ","),
                   " (",
                   prettyNum(100*pct_schools_libraries, digits = 0),
                   "%) are within 250\nmeters of a public school.",
                   sep = ""),
           hjust = .25, vjust = .25, size = 3) +
  theme_map() +
  ggtitle("Boston libraries by proximity to public schools") +
  theme(panel.background = element_rect(fill = "gray98"),
        legend.position="right", legend.background = element_rect(fill = alpha("white", 0.5), color = "gray"))

libraries_by_schools

png(file="C:/Users/gemma/OneDrive/GSD Semester 1/Spatial Analysis/Final Portfolio/Figures/libraries_by_schools.png",
width = 6,
  height    = 4,
  units     = "in",
  res       = 1000)
libraries_by_schools
dev.off()
  
```



### The number and proportion of libraries within each neighborhood
The number and proportion of C polygons containing A points.
```{r}
nhoods <- nhoods %>%
  mutate(num_libraries = lengths(st_covers(nhoods, libraries)))

libraries_nhoods <- ggplot(nhoods) +
  geom_sf(color = NA, 
  aes(fill = num_libraries)) +
  scale_fill_viridis_c(name = "Neighborhoods\nby number of libraries", breaks = breaks <- seq(0, 10, by = 1), labels = paste(prettyNum(breaks, big.mark = ","), "libraries")) +
  annotation_scale(location = "br") +
  theme_map() +
ggtitle("Boston neighborhoods by number of libraries") +
theme(panel.background = element_rect(fill = "gray98"),
        legend.position="right", legend.background = element_rect(fill = alpha("white", 0.5), color = "gray"))

libraries_nhoods

png(file="C:/Users/gemma/OneDrive/GSD Semester 1/Spatial Analysis/Final Portfolio/Figures/libraries_nhoods.png",
width = 6,
  height    = 4,
  units     = "in",
  res       = 1000)
libraries_nhoods
dev.off()

```


### Neighborhoods with parks in them
The number and proportion of C polygons that overlap with D polygons.
```{r}
nhoods <- nhoods %>%
  mutate(num_parks = lengths(st_overlaps(nhoods, parks))) %>%
  mutate(has_parks = num_parks > 0)

n_parks_nhoods <- sum(nhoods$has_parks)

n_parks_nhoods

left_side  <- st_bbox(parks)$xmin
top_side <- st_bbox(parks)$ymax

parks_nhoods <- ggplot(nhoods) +
  geom_sf(aes(fill = has_parks)) +
 scale_fill_manual(values = c("#FDE725FF", "#73D055FF"),
          name = "Boston neighborhoods\nby presence of a park", 
          labels = c("Neighborhood without a park",
                     "Neighborhood with a park")) +
  annotation_scale(location = "br") +
  annotate(geom = "text", x = left_side, 
           y = top_side,
           label = paste(n_parks_nhoods ,
                         "of Boston's", 
                         length(nhoods$Name),
                         "neighborhoods contain\nor overlap", 
                         "with a park."),
           hjust = 0, vjust = .6, size = 3) +
  theme_map() +
  ggtitle("Boston neighborhoods that contain parks") +
  theme(panel.background = element_rect(fill = "gray98"), legend.position="right",
        legend.background = element_rect(fill = alpha("white", 0.5), color = "gray"))

parks_nhoods

png(file="C:/Users/gemma/OneDrive/GSD Semester 1/Spatial Analysis/Final Portfolio/Figures/parks_nhoods.png",
width = 6,
  height    = 4,
  units     = "in",
  res       = 1000)
parks_nhoods
dev.off()
```


### Neighborhoods with parks greater that 100,000 square meters
```{r}
parks$area <- st_area(parks)
parks$area = as.numeric(gsub("[m^2]", "", parks$area))

big_parks <- parks[parks$area > 100000, ]

nhoods <- nhoods %>%
  mutate(num_big_parks = lengths(st_overlaps(nhoods, big_parks))) %>%
  mutate(has_big_parks = num_big_parks > 0)

n_parks_nhoods <- sum(nhoods$has_big_parks)

n_parks_nhoods

left_side  <- st_bbox(parks)$xmin
top_side <- st_bbox(parks)$ymax

bigparks_nhoods <- ggplot(nhoods) +
  geom_sf(aes(fill = has_big_parks)) +
 scale_fill_manual(values = c("#FDE725FF", "#73D055FF"),
          name = "Boston neighborhoods\nby presence of a big park", 
          labels = c("Neighborhood without a big park",
                     "Neighborhood with a big park")) +
  annotation_scale(location = "br") +
  annotate(geom = "text", x = left_side, 
           y = top_side,
           label = paste(n_parks_nhoods ,
                         "of Boston's", 
                         length(nhoods$Name),
                         "neighborhoods contain\nor overlap with", 
                         "a big park."),
           hjust = .05, vjust = .7, size = 3) +
  theme_map() +
  ggtitle("Boston neighborhoods that contain big parks") +
  theme(panel.background = element_rect(fill = "gray98"), legend.position="right",
        legend.background = element_rect(fill = alpha("white", 0.5), color = "gray"))

bigparks_nhoods

png(file="C:/Users/gemma/OneDrive/GSD Semester 1/Spatial Analysis/Final Portfolio/Figures/bigparks_nhoods.png",
width = 6,
  height    = 4,
  units     = "in",
  res       = 1000)
bigparks_nhoods
dev.off()

```


### Neighborhoods by number of public schools
The number and proportion of C polygons containing B points.
```{r}
nhoods <- nhoods %>%
  mutate(num_schools = lengths(st_covers(nhoods, schools)))

schools_nhoods <- ggplot(nhoods) +
  geom_sf(color = NA, 
  aes(fill = num_schools)) +
  scale_fill_viridis_c(name = "Neighborhoods by \nnumber of public schools", breaks = breaks <- seq(0, 25, by = 5), labels = paste(prettyNum(breaks, big.mark = ","), "schools")) +
  annotation_scale(location = "br") +
  theme_map() +
ggtitle("Boston neighborhoods by number of schools") +
theme(panel.background = element_rect(fill = "gray98"),
        legend.position="right", legend.background = element_rect(fill = alpha("white", 0.5), color = "gray"))

schools_nhoods

png(file="C:/Users/gemma/OneDrive/GSD Semester 1/Spatial Analysis/Final Portfolio/Figures/schools_nhoods.png",
width = 6,
  height    = 4,
  units     = "in",
  res       = 1000)
schools_nhoods
dev.off()
```


### Average density of schools in each neighborhood
The average density of B points in each C polygon.
```{r}
nhoods <- nhoods %>%
  mutate(num_schools = lengths(st_covers(nhoods, schools)))

nhoods$area <- st_area(nhoods)
nhoods$area = as.numeric(gsub("[m^2]", "", nhoods$area))

nhoods <- nhoods %>%
  mutate(density_schools = (num_schools / nhoods$area)*100000)

ggplot(nhoods) +
  geom_sf(color = NA, 
  aes(fill = density_schools)) +
  scale_fill_viridis_c(name = "Number of schools per \n100K square meters", breaks = breaks <- seq(0, 20, by = 5 ), labels = paste(prettyNum(breaks, big.mark = ","), "schools")) +
  annotation_scale(location = "br") +
  theme_map() +
ggtitle("Boston neighborhoods by density of public schools") +
theme(panel.background = element_rect(fill = "gray98"),
        legend.position="right", legend.background = element_rect(fill = alpha("white", 0.5), color = "gray"))

```


### Density of libraries in each neighborhoods
The average density of A points in each C polygon.
```{r}
nhoods <- nhoods %>%
  mutate(num_libraries = lengths(st_covers(nhoods, libraries)))

nhoods$area <- st_area(nhoods)
nhoods$area = as.numeric(gsub("[m^2]", "", nhoods$area))

nhoods <- nhoods %>%
  mutate(density_libraries = (num_libraries / nhoods$area)*100000)

ggplot(nhoods) +
  geom_sf(color = NA, 
  aes(fill = density_libraries)) +
  scale_fill_viridis_c(name = "Number of libraries per \n100K square meters", breaks = breaks <- seq(0, 2, by = .5), labels = paste(prettyNum(breaks, big.mark = ","), "libraries")) +
  annotation_scale(location = "br") +
  theme_map() +
ggtitle("Neighborhoods by density of public libraries") +
theme(panel.background = element_rect(fill = "gray98"),
        legend.position="right", legend.background = element_rect(fill = alpha("white", 0.5), color = "gray"))
```


### Average distance between public schools and the nearest libraries
The average distance between B points and their nearest respective A points.
```{r}
schools <- schools %>%
  mutate(library_dist = st_nn(schools, libraries, 
                           returnDist = TRUE)$dist) %>%
  mutate(library_dist = as.numeric(library_dist))

avg_library_dist <- mean(schools$library_dist)
avg_library_dist
```
```{r}

schools_libraries <- ggplot(nhoods) +
  geom_sf(fill = NA, color = "black") +
  geom_sf(data = schools, size = 2,
          aes(color = library_dist)) +
  scale_color_viridis_c(direction = -1, name = 
                          "Distance to \nlibrary (meters)", breaks = breaks <- seq(0, 2500, by = 500),) +
  theme_map() +
ggtitle("Boston public schools by distance to a library") +
theme(panel.background = element_rect(fill = "gray98"),
        legend.position="right", legend.background = element_rect(fill = alpha("white", 0.5), color = "gray"))

schools_libraries

png(file="C:/Users/gemma/OneDrive/GSD Semester 1/Spatial Analysis/Final Portfolio/Figures/schools_libraries.png",
width = 6,
  height    = 4,
  units     = "in",
  res       = 1000)
schools_libraries
dev.off()
```


